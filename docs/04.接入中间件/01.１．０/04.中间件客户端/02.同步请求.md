---
title: 同步请求
date: 2021-11-23 10:19:36
permalink: /pages/1c5b20/
---

# 同步请求

## 一、同步单次请求

> 同步单次请求，发送则得到返回结果。

```java
        // 构建请求参数
        Map<String, Object> map = new HashMap<>(1);
        map.put("loginName", "Tom");
        // 发送请求，并获取返回结果
        InterCoResult result = MiddlewareClient
                // 填写中间件地址及端口号，及超时时间（毫秒），地址及端口号填写配置文件中 middleware-recServer 下的配置
                .create("http://localhost:8888", 50000)
                // 请求类型，根据服务定义设置
                .setHttpType(HttpType.GET)
                // 中间件中的服务id，根据yml文件中 repchain-services-serviceId 配置填写，决定请求哪个服务
                .setServiceId("1")
                // 设置服务定义访问的url
                .setUrl("/user/valid")
                // 设置传输的数据
                .setForm(map)
                // 发送数据
                .msg();
```

## 二、同步多次请求

> 同步多次请求，如果多次请求包含在同一个方法中，推荐将存证的请求cid设置成一致。

> 若将请求cid设置为同一个，则需要将每次请求的序号进行递增操作。

```java
        // 1.第一次请求
        Map<String, Object> map = new HashMap<>(1);
        map.put("loginName", "12110107bi45jh675g");
        // 传输设置
        ReqOption reqOption = new ReqOption();
        // 设置是否为最后一次请求，默认为true
        reqOption.setIsEnd(ReqOption.FALSE);
        InterCoResult result = MiddlewareClient
                // 填写中间件地址及端口号，及超时时间
                .create("http://localhost:8888", 50000)
                // 请求类型，根据接口定义设置
                .setHttpType(HttpType.GET)
                // 中间件中的服务id，根据yml文件配置填写
                .setServiceId("1")
                // 设置访问的url
                .setUrl("/user/valid")
                // 设置传输的数据
                .setForm(map)
                // 发送数据
                .msg(reqOption);
        // 2. 第二次请求
        reqOption = new ReqOption();
        // 由于是同一次请求，所以请求id需要一致，获取上一次请求id
        reqOption.setCid(result.getCid());
        // 设置请求序号，默认为1
        reqOption.setSeq(2);
        // 设置是否为最后一次请求，默认为true
        reqOption.setIsEnd(ReqOption.FALSE);
        // 设置请求参数
        map = new HashMap<>(1);
        map.put("loginName", "yewu");
        result = MiddlewareClient
                // 填写中间件地址及端口号，及超时时间
                .create("http://localhost:8888", 50000)
                // 请求类型，根据接口定义设置
                .setHttpType(HttpType.GET)
                // 中间件中的服务id，根据yml文件配置填写
                .setServiceId("1")
                // 设置访问的url
                .setUrl("/user/valid")
                // 设置传输的数据
                .setForm(map)
                // 发送数据
                .msg(reqOption);
        // 3. 第三次请求 （最后一次请求）
        reqOption = new ReqOption();
        // 由于是同一次请求，所以请求id需要一致，获取上一次请求id
        reqOption.setCid(result.getCid());
        // 设置请求序号，默认为1
        reqOption.setSeq(3);
        // 设置请求参数
        map = new HashMap<>(1);
        map.put("loginName", "test");
        result = MiddlewareClient
                // 填写中间件地址及端口号，及超时时间
                .create("http://localhost:8888", 50000)
                // 请求类型，根据接口定义设置
                .setHttpType(HttpType.GET)
                // 中间件中的服务id，根据yml文件配置填写
                .setServiceId("1")
                // 设置访问的url
                .setUrl("/user/valid")
                // 设置传输的数据
                .setForm(map)
                // 发送数据
                .msg(reqOption);

```
## 三、同步上传文件

:::warning

1. 上传文件的方式为，将文件的 **绝对路径** 发送给中间件，而不是将文件流发送给中间件。
2. 由于中间件和宿主服务部署在同一个操作系统中，所以中间件接收到文件路径后，可以直接读取到文件，并通过grpc方式发送给服务方中间件，进行文件传输。
3. 同步上传文件方式仅适用于较小的文件传输，如果文件较大，请适当增加客户端超时时间，或选择异步文件传输的方式进行文件上传。
4. 由于中间件托管了文件传输，所以在文件传输过程中可以携带参数进行传输。
4. 当前版本文件传输，单次请求只支持单文件传输。若要传输多个文件，请将多个文件压缩为一个文件进行传输，或者多次调用文件传输请求。

:::

```java
Map<String, Object> map = new HashMap<>(1);
map.put("editor", "Jack");
InterCoResult result = MiddlewareClient
        // 填写中间件地址及端口号，及超时时间
        .create("http://localhost:8888", 50000)
        // 请求类型，根据接口定义设置
        .setHttpType(HttpType.POST)
        // 中间件中的服务id，根据yml文件配置填写
        .setServiceId("1")
        // 设置访问的url
        .setUrl("/upload")
        // 设置传输的数据
        .setForm(map)
        // 设置文件在传输参数中字段
        .setFileField("file")
        // 设置传输的文件
        .setFile(new File("/home/repchain/test.tar.gz"))
        // 发送数据
        .sendFile();
```
