---
title: 异步请求
date: 2021-11-23 16:41:03
permalink: /pages/92470c/
---

# 异步请求

## 异步接口描述

<ClientOnly><Swagger-SwaggerShow></Swagger-SwaggerShow></ClientOnly>

## 一、异步单次请求

> 异步调用具体说明参考[HTTP异步请求概述](/pages/7c927c/)

### 1. 调用方代码

:::tip

异步请求时，必须在`ReqOption`对象中，设置`callBackUrl`和`callBackMethod`两个参数。

此处两个参数用于告诉服务方的中间件，具体的应答接口几应答接口的类型。

:::

```java

// 构建请求参数
        Map<String, Object> map = new HashMap<>(1);
        map.put("pageSize", 1);
        map.put("pageNo", 10);
        // 设置请求配置对象
        ReqOption option = new ReqOption();
        // 设置为异步请求
        option.setSync(ReqOption.FALSE);
        // 设置异步请求应答接口地址
        option.setCallbackUrl("/callback");
        // 设置异步请求接口应答地址请求类型
        option.setCallbackMethod(HttpType.GET.toString());
        // 发送请求，并获取返回结果
        InterCoResult result = MiddlewareClient
                // 填写中间件地址及端口号，及超时时间
                .create("http://localhost:8888", 50000)
                // 请求类型，根据接口定义设置
                .setHttpType(HttpType.GET)
                // 中间件中的服务id，根据yml文件配置填写
                .setServiceId("1")
                // 设置访问的url
                .setUrl("/user/async")
                // 设置传输的数据
                .setForm(map)
                // 发送数据
                .msg(option);
```
### 2. 服务方应答代码

:::tip

1. 服务方在应答时需要知道应答id。
2. 应答会随着参数一起传如接口，使用`request.getParameter("callbakcId")`可接收到应答id。
3. 此处代码示例展示的为服务方应答时的代码示例。

:::

```java
        // 从数据库获取调用方请求的数据
        List<Map<String, Object>> list = baseMapper.selectAll("table_name",pageSize,pageNo);
        // 构建请求参数
        Map<String, Object> map = new HashMap<>(1);
        map.put("data", list);
        // 传输设置
        ReqOption reqOption = new ReqOption();
        // 设置为应答
        reqOption.setBReq(ReqOption.FALSE);
        // 设置为异步请求
        reqOption.setSync(ReqOption.FALSE);
        // 发送请求，并获取返回结果
        InterCoResult result = MiddlewareClient
            // 填写中间件地址及端口号，及超时时间（毫秒），地址及端口号填写配置文件中 middleware-recServer 下的配置
            .create("http://localhost:8888", 50000)
            // 设置传输的数据
            .setForm(map)
            // 设置回调id，会随着请求一起传到服务方，每次请求都是唯一的
            .setCallBackId(callbackId)
            // 发送数据
            .msg(reqOption);

```

## 二、异步多次请求

> 异步多次请求，可以参考[同步多次请求](/pages/1c5b20/#二、同步多次请求)，就是将异步单次操作进行多次调用。

:::warning

1. 异步多次请求参考同步请求时，需要设置请求为异步（sync=false），同时需要设置应答接口url(callbackUrl)及应答接口类型(CallbackMethod)。
2. 如果多次请求的应答接口均为同一个，则推荐将请求ID（cid）也设置为同一个。

:::

## 三、异步上传文件

:::warning

1. 上传文件的方式为，将文件的 **绝对路径** 发送给中间件，而不是将文件流发送给中间件。
2. 由于中间件和宿主服务部署在同一个操作系统中，所以中间件接收到文件路径后，可以直接读取到文件，并通过grpc方式发送给服务方中间件，进行文件传输。
3. 由于中间件托管了文件传输，所以在文件传输过程中可以携带参数进行传输。
4. 当前版本文件传输，单次请求只支持单文件传输。若要传输多个文件，请将多个文件压缩为一个文件进行传输，或者多次调用文件传输请求。

:::

* 调用方代码

```java
        // 设置传输参数
        Map<String, Object> map = new HashMap<>(1);
        map.put("editor", "Jack");
        ReqOption option = new ReqOption();
        // 设置为异步请求
        option.setSync(ReqOption.FALSE);
        // 设置异步请求应答接口地址
        option.setCallbackUrl("/callbackUpload");
        // 设置异步请求接口应答地址请求类型
        option.setCallbackMethod(HttpType.GET.toString());
        // 发送请求，并获取返回结果
        InterCoResult result = MiddlewareClient
                // 填写中间件地址及端口号，及超时时间
                .create("http://localhost:8888", 500000)
                // 请求类型，根据接口定义设置
                .setHttpType(HttpType.GET)
                // 中间件中的服务id，根据yml文件配置填写
                .setServiceId("1")
                // 设置访问的url
                .setUrl("/user/asyncUpload")
                // 设置传输的数据
                .setForm(map)
                // 设置文件接受的字段
                .setFileField("file")
                // 设置需要传输的文件
                .setFile(new File("/Users/Downloads/xxx.tar.gz"))
                // 发送数据
                .sendFile(option);
```
* 服务方应答代码

:::tip

1. 服务方在应答时需要知道应答id。
2. 应答会随着参数一起传如接口，使用`request.getParameter("callbakcId")`可接收到应答id。
3. 此处代码示例展示的为服务方应答时的代码示例。
4. 此部分代码用于添加到接收文件完成后，告诉调用方已经完成文件接收，如果接收文件失败也可以通过此方式进行通知。

:::


```java
        // 构建请求参数
        Map<String, Object> map = new HashMap<>(1);
        map.put("data", "ok");
        // 传输设置
        ReqOption reqOption = new ReqOption();
        reqOption.setBReq(ReqOption.FALSE);
        reqOption.setSync(ReqOption.FALSE);
        // 发送请求，并获取返回结果
        InterCoResult result = MiddlewareClient
                // 填写中间件地址及端口号，及超时时间（毫秒），地址及端口号填写配置文件中 middleware-recServer 下的配置
                .create("http://localhost:8888", 50000)
                // 设置传输的数据
                .setForm(map)
                // 设置回调id，会随着请求一起传到服务方，每次请求都是唯一的
                .setCallBackId(callbackId)
                // 发送数据
                .msg(reqOption);
```

## 四、异步下载文件


:::tip

1. 异步下载文件其实是由调用方申请文件。
2. 服务方获取申请后进行审批等流程，然后将文件推送给服务方。

:::

* 调用方请求代码

> 服务方发送普通的异步消息进行请求

```java
        // 构建请求参数
        Map<String, Object> map = new HashMap<>(1);
        map.put("editor", "Jack");
        map.put("file", "xxx.tar.gz");
        // 设置请求配置对象
        ReqOption option = new ReqOption();
        // 设置为异步请求
        option.setSync(ReqOption.FALSE);
        // 设置异步请求应答接口地址
        option.setCallbackUrl("/callbackDownload");
        // 设置异步请求接口应答地址请求类型
        option.setCallbackMethod(HttpType.GET.toString());
        // 发送请求，并获取返回结果
        InterCoResult result = MiddlewareClient
                // 填写中间件地址及端口号，及超时时间
                .create("http://localhost:8888", 50000)
                // 请求类型，根据接口定义设置
                .setHttpType(HttpType.GET)
                // 中间件中的服务id，根据yml文件配置填写
                .setServiceId("1")
                // 设置访问的url
                .setUrl("/user/asyncDownload")
                // 设置传输的数据
                .setForm(map)
                // 发送数据
                .msg(option);
```
* 服务方应答代码

:::warning

如果文件较大，请将超时时间适当延长。

:::

```java
        // 构建请求参数
        Map<String, Object> map = new HashMap<>(1);
        map.put("data", "ok");
        // 传输设置
        ReqOption reqOption = new ReqOption();
        // 设置为应答
        reqOption.setBReq(ReqOption.FALSE);
        // 发送请求，并获取返回结果
        InterCoResult result = MiddlewareClient
                // 填写中间件地址及端口号，及超时时间（毫秒），地址及端口号填写配置文件中 middleware-recServer 下的配置
                .create("http://localhost:8888", 50000)
                // 设置传输的数据
                .setForm(map)
                // 设置回调id，会随着请求一起传到服务方，每次请求都是唯一的
                .setCallBackId(callbackId)
                // 设置文件
                .setFile(new File("/xxx.tar.gz"))
                // 设置文件参数
                .setFileField("file")
                // 发送数据
                .sendFile(reqOption);
```
