---
title: HTTP单次同步请求
date: 2021-10-22 17:31:46
permalink: /pages/feba98/
---

# HTTP单次同步请求

!!! tip "提示"

    推荐使用[接入中间件](/mid/)进行接口存证，可大大减少用户代码量。



## 一、概述

> 同步请求，即为客户端请求一次服务端就返回数据，没有第二次请求。
>
> 此类情况则只完成一次[存证过程](/pages/0ebad0/#二、存证过程-概要)即可。

## 二、请求步骤

### **请求方**

> 1. 构建请求数据
> 2. 对数据进行[数据签名](/pages/e84ef5/#数据签名)
> 3. 构建存证请求头
> 4. 发送请求数据到服务端，并接收返回结果
> 6. 构建[交易对象](/pages/e84ef5/#交易对象)
> 7. 提交给RepChain区块链

### **服务方**

> 1. 获取请求参数及请求头信息
> 2. [数据验签](/pages/e84ef5/#数据验签)判断权限
> 3. 执行业务操作获取返回数据
> 4. 对返回数据进行[数据签名](/pages/e84ef5/#数据签名)
> 5. 返回数据及签名信息给请求方

## 三、代码示例

### **请求方**

1. 构建请求数据

    ```java linenums="1"
           // 构建接口调用参数
           Map<String, Object> paramMap = new HashMap<>(3);
           paramMap.put("name", "Tom");
    ```

2. 对数据进行[数据签名](/pages/e84ef5/#数据签名)

    ```java linenums="1"
           // 生成本次请求的存证id，此id会在本次请求存证中重复使用
           String cid = SnowIdGenerator.getId();
           // 获取yml文件中的信息，例如证书信息，请求接口等
           RepchainConfig repchainConfig = YamlUtils.repchainConfig;
           List<InterCo> interCoList = repchainConfig.getRepchain().getInterCo();
           InterCo interCo = interCoList.get(0);
           List<Service> services = interCo.getServices();
           Service service = services.get(0);
           // 对业务请求数据进行hash取值
           String contentHash = DigestUtil.sha256Hex(JSONUtil.toJsonStr(paramMap));
           // 使用yml文件中的公钥和证书，对业务请求参数进行数据签名
           Signature signature = getSignature(interCo, contentHash);
    ```

3. 构建存证的请求头

    ```java linenums="1"
           // 此处需要将构建的请求头内容传给服务方，此处请求头信息包含了接口协同需要存证的信息
           // 及数据签名需要校验的身份信息
           Header header = customHeader(service, cid, true, signature);
           paramMap.put("header", JSONUtil.toJsonStr(header));
    ```

4. 发送请求数据到服务端

    ```java linenums="1"
           // 请求业务接口，服务方接口地址及端口号可从dashboard管理平台获取，然后将端口号和地址写入到yml文件中
           String result = HttpUtil.get("http://" + service.getTo_host() + ":" + service.getTo_port() + "/info", paramMap);
           // 获取返回结果对象
           InterCoResult resultMap = JSONUtil.toBean(result, InterCoResult.class);
    ```


5. 构建[交易对象](/pages/e84ef5/#交易对象)

    ```java linenums="1"
           // 获取服务提供方签名信息
           Signature responseSignature = resultMap.getSignature();
           // 构建证书对象，用于签名数据及校验权限用
           SysCert sysCert = PkUtil.getSysCert(interCo);
           // 获取yml文件中配置的host地址
           String host = repchainConfig.getRepchain().getHost();
           // 构建存证交易对象，使用证书和私钥对存证信息进行数据签名，提交给区块链进行存证
           ReqAckProof rb = getReqAckProof(header, contentHash, signature, responseSignature);
    ```

6. 提交给RepChain区块链

    ```java linenums="1"
           // 创建请求实例，若用Spring 此处可以创建javabean，host为地址加端口号，例：127.0.0.1:8080
           RequestAck requestAck = new RequestAck(host);
           JSONObject jsonObject = requestAck.rb(rb, sysCert);
           // 若果有错误信息，则提交存证数据失败
           if (!StrUtil.isBlankIfStr(jsonObject.get("err"))) {
               System.out.println("提交区块链数据失败：" + jsonObject);
           }
    ```

!!! tip "提示"

    完整代码可在代码示例中`repchian.inter.cooperation.http.sync.single.request`查看或点击 [***此处***](https://gitee.com/BTAJL/api-coord/blob/http-lhc/src/main/java/repchain/inter/cooperation/http/sync/single/request/SyncClient.java) 在线查看。



### **服务方**

1. 获取请求参数及存证请求头信息

    > 此处获取的header为存证的请求头，示例中将请求头放到request的parameter中传递到服务端。

    ```java linenums="1"
    // 获取调用方请求头header信息
    String headerStr = request.getParam("header");
    Header header = JSONUtil.toBean(headerStr, Header.class);
    // 获取业务请求数据
    String name = request.getParam("name");
    ```

2. [数据验签](/pages/e84ef5/#数据验签)判断权限

    ```java linenums="1"
    // 2.校验请求方权限，校验请求方数据签名
    if (validAuth( header)) {
     // 编写业务代码及后续代码
    }else{
     // 返回结果没有权限
    }
    ```

3. 执行业务操作获取返回数据

    > 此处请根据实际业务进行业务代码的编写，文档中暂时不做代码示例。

4. 对返回数据进行[数据签名](/pages/e84ef5/#数据签名)

    ```java linenums="1"
    // 返回业务数据的数据结果
    Map<Object,Object> info = new HashMap<>(1);
    // 构建返回结果数据
    InterCoResult result = result
           .toBuilder()
           // 状态码
           .code(0)
           // 状态信息
           .msg("success")
           // 返回数据
           .data(info)
           // 签名数据
           .signature(sign(info))
           .build();
    ```

5. 返回数据及签名信息给请求方

    ```java linenums="1"
    return result;
    ```


!!! tip "提示"

    完整代码可在代码示例中`repchian.inter.cooperation.http.sync.single.response`查看或点击 [***此处***](https://gitee.com/BTAJL/api-coord/blob/http-lhc/src/main/java/repchain/inter/cooperation/http/sync/single/response/SyncServer.java) 在线查看。

